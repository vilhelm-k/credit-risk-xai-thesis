# Explainable AI for Credit Risk Prediction

**Thesis Title**: Explainable AI for Credit Risk Prediction: A Study of Swedish SMEs Using LightGBM and SHAP

**Authors**: Vilhelm Karlin, Minna Olsson

**Contact**: 26012@student.hhs.se, 26027@student.hhs.se

**Course**: BE451 - Degree Project in Finance, Stockholm School of Economics, Fall 2025

---

## Data

### Included Data Files

This submission includes pre-processed interim data files in `data/interim/`:

| File | Size | Description |
|------|------|-------------|
| `serrano_base.parquet` | 1.36 GB | Serrano database loaded and concatenated |
| `macro_annual.parquet` | 5 KB | Annual macroeconomic indicators |

These interim files are provided to reduce submission size (vs. 22 GB raw data) while maintaining full reproducibility of the analysis.

### How the Interim Files Were Generated

**`serrano_base.parquet`** was generated by `credit_risk_xai/data/make_dataset.py`:
1. Loaded 10 Stata files (`serrano1.dta` through `serrano10.dta`) from the Serrano database
2. Filtered for limited liability companies only (`ser_jurform == 49`)
3. Computed derived fields:
   - `company_age`: Years since company registration (`ser_year - ser_regdat.year`)
   - `credit_event`: Binary indicator for bankruptcy or reorganization occurring in that year
   - `sme_category`: EU SME classification based on employees, revenue, and assets
4. Optimized data types for memory efficiency
5. Concatenated into a single parquet file

**`macro_annual.parquet`** was generated by `credit_risk_xai/data/make_macro.py`:
1. Loaded lending rate data from Statistics Sweden (SCB)
2. Filtered for non-financial corporation borrowing rates (new and renegotiated agreements)
3. Computed annual averages for short-term (up to 3 months) and long-term (over 5 years) rates
4. Calculated `term_spread = long_term_rate - short_term_rate`

### Original Data Sources

**Serrano Database**:
- Provider: Swedish House of Finance Research Data Center, Stockholm School of Economics
- Access: Restricted to SSE researchers
- URL: https://www.hhs.se/en/houseoffinance/data-center/
- Content: Financial statement data for Swedish companies (1998-2023)

**Macroeconomic Data (Term Spread)**:
```bibtex
@misc{scb2025lending,
  author       = {{Statistics Sweden}},
  title        = {Lending Rates to Households and Non-Financial Corporations,
                  Breakdown by Fixation Periods},
  year         = {2025},
  howpublished = {Statistical Database},
  url          = {https://www.statistikdatabasen.scb.se/pxweb/en/ssd/START__FM__FM5001__FM5001C/RantaT01N/},
  note         = {Accessed: September 2025}
}
```

### Rebuilding from Raw Data (Optional)

If you have access to the raw Serrano `.dta` files and wish to rebuild from scratch:

```bash
# Place raw files in data/raw/ and SCB lending rates CSV in data/external/, then run:
python3 credit_risk_xai/data/make_dataset.py   # Raw .dta → interim parquet
python3 credit_risk_xai/data/make_macro.py     # Lending rates CSV → macro parquet
```

---

## Requirements

- Python 3.12
- Dependencies listed in `requirements.txt`

---

## Setup and Replication

### 1. Create and activate a virtual environment

```bash
python3 -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate
```

### 2. Install dependencies

```bash
pip install -r requirements.txt
```

### 3. Build the processed dataset

Starting from the provided interim files, run the feature engineering pipeline:

```bash
python3 credit_risk_xai/features/engineer.py
```

This reads `data/interim/serrano_base.parquet` and `data/interim/macro_annual.parquet`, engineers 22 features, and outputs `data/processed/serrano_features.parquet`.

### 4. Run analysis notebooks

Execute the notebooks in order to reproduce all figures and tables:

| Notebook | Description | Outputs |
|----------|-------------|---------|
| `notebooks/00_data_exploration.ipynb` | Descriptive statistics, filter analysis | `figures/default_rate_by_year.pdf`, `tables/descriptive_stats.tex` |
| `notebooks/05a_xai_global.ipynb` | Global XAI analysis (SHAP, ALE) | `figures/roc_curve.pdf`, `figures/calibration_curve.pdf`, `figures/shap_*.pdf`, `figures/ale_*.pdf`, `figures/interaction_*.pdf` |
| `notebooks/05b_xai_temporal.ipynb` | Temporal XAI analysis | `figures/temporal_*.pdf` |

---

## Project Structure

```
credit-risk-xai-thesis/
├── README.md                      <- This file
├── FEATURES.md                    <- Feature definitions with formulas
├── requirements.txt               <- Python dependencies
├── pyproject.toml                 <- Project metadata
│
├── credit_risk_xai/               <- Source code package
│   ├── config.py                  <- Configuration and feature definitions
│   ├── plotting.py                <- Thesis-quality plotting utilities
│   ├── data/
│   │   ├── make_dataset.py        <- Raw Serrano .dta → interim parquet
│   │   └── make_macro.py          <- External CSVs → macro parquet
│   ├── features/
│   │   └── engineer.py            <- Feature engineering pipeline
│   └── modeling/
│       ├── train.py               <- LightGBM training
│       ├── evaluate.py            <- Evaluation metrics (AUC, ECE, etc.)
│       ├── explain.py             <- SHAP explanations
│       ├── ale.py                 <- ALE plot computation
│       └── logit.py               <- Logistic regression baseline
│
├── data/
│   ├── raw/                       <- Serrano .dta files (not included, see above)
│   ├── external/                  <- SCB lending rates CSV (not included, see above)
│   ├── interim/                   <- INCLUDED: serrano_base.parquet, macro_annual.parquet
│   └── processed/                 <- Generated: serrano_features.parquet
│
├── notebooks/
│   ├── 00_data_exploration.ipynb  <- Descriptive statistics
│   ├── 05a_xai_global.ipynb       <- Global XAI analysis
│   ├── 05b_xai_temporal.ipynb     <- Temporal XAI analysis
│   └── archive/                   <- Exploratory notebooks (not part of final analysis)
│
├── figures/                       <- Generated thesis figures
└── tables/                        <- Generated LaTeX tables
```

---

## Output Mapping

The following table maps each thesis output to its source code location:

### Tables

| Table | Source | Notebook | Notes |
|-------|--------|----------|-------|
| Descriptive Statistics | `tables/descriptive_stats.tex` | `00_data_exploration.ipynb` | Auto-generated LaTeX file |
| Logit Coefficients | Notebook output | `05a_xai_global.ipynb` | Printed via `.to_latex()` in cell output |
| Model Performance Comparison | Notebook output | `05a_xai_global.ipynb` | AUC, PR-AUC, Brier, ECE metrics printed in cell output |

### Figures

| Figure | Source | Notebook |
|--------|--------|----------|
| Default Rate by Year | `figures/default_rate_by_year.pdf` | `00_data_exploration.ipynb` |
| ROC Curve | `figures/roc_curve.pdf` | `05a_xai_global.ipynb` |
| Calibration Curve | `figures/calibration_curve.pdf` | `05a_xai_global.ipynb` |
| SHAP Importance | `figures/shap_importance_comparison.pdf` | `05a_xai_global.ipynb` |
| SHAP Beeswarm (LightGBM) | `figures/shap_beeswarm_lgbm.pdf` | `05a_xai_global.ipynb` |
| SHAP Beeswarm (Logit) | `figures/shap_beeswarm_logit.pdf` | `05a_xai_global.ipynb` |
| ALE Plots (Full) | `figures/ale_full.pdf` | `05a_xai_global.ipynb` |
| ALE Plots (Individual) | `figures/ale_*.pdf` | `05a_xai_global.ipynb` |
| Interaction Analysis | `figures/interaction_*.pdf` | `05a_xai_global.ipynb` |
| SHAP Interaction Heatmap | `figures/shap_interaction_heatmap.pdf` | `05a_xai_global.ipynb` |
| Temporal Importance Ranks | `figures/temporal_importance_ranks.pdf` | `05b_xai_temporal.ipynb` |
| ALE Temporal Evolution | `figures/ale_temporal_evolution.pdf` | `05b_xai_temporal.ipynb` |
| Group Importance Evolution | `figures/temporal_group_importance.pdf` | `05b_xai_temporal.ipynb` |
| Group Correlation | `figures/temporal_group_correlation.pdf` | `05b_xai_temporal.ipynb` |

---

## Feature Documentation

See [FEATURES.md](FEATURES.md) for complete documentation of all 22 model features, including:
- Variable definitions and formulas
- Source column mappings to Serrano database
- Data filters applied
- Macroeconomic data sources

---

## Model Configuration

The model uses LightGBM with the following configuration (defined in `credit_risk_xai/modeling/train.py`):

- **Objective**: Binary classification (default prediction)
- **Metric**: Log-loss with early stopping
- **Features**: 22 features (V2 Altman/Ohlson aligned)
- **Categorical handling**: Native LightGBM categorical support for `sni_group_3digit`

---

## Exploratory Notebooks

The `notebooks/archive/` directory contains notebooks used during development but not part of the final analysis:

- `00a_hyperparameter_tuning.ipynb` - Optuna hyperparameter optimization
- `00b_ml_comparison.ipynb` - Model comparison experiments
- `00_data_quality_audit.ipynb` - Data quality checks
- `01_exploration.ipynb` - Initial data exploration
- `02_modelling_test.ipynb` - Model prototyping
- `03_feature_selection.ipynb` - Feature selection experiments
- `04_feature_pruning.ipynb` - Feature pruning analysis
- `05_xai_exploration.ipynb` - XAI method exploration
- `05bb_xai_temporal_oneyear.ipynb` - Single-year temporal analysis
- `05c_xai_case_studies.ipynb` - Individual case studies
- `05d_xai_clustering.ipynb` - SHAP-based clustering

These notebooks have cleared outputs to reduce file size.
